---
interface Props {
  coordinates: {
    lat: number;
    lng: number;
  };
  propertyName: string;
  nearbyAttractions?: Array<{
    name: string;
    type: 'beach' | 'restaurant' | 'attraction' | 'shopping' | 'airport' | 'landmark';
    distance: string;
    coordinates: {
      lat: number;
      lng: number;
    };
    description?: string;
  }>;
}

const { coordinates, propertyName, nearbyAttractions = [] } = Astro.props;
const apiKey = import.meta.env.PUBLIC_GOOGLE_MAPS_API_KEY;

// Icon paths for different attraction types
const categoryIcons: Record<string, string> = {
  beach: 'M2 10q4-4 8 0t8 0M2 16q4-4 8 0t8 0',
  restaurant: 'M8 2v14m8-14v6a2 2 0 01-2 2H8',
  attraction: 'M12 2l3.1 6.3 6.9.9-5 4.9 1.2 6.9-6.2-3.3-6.2 3.3 1.2-6.9-5-4.9 6.9-.9z',
  shopping: 'M4 4h2l3.5 10h7l3-7H7.5M10 20a2 2 0 110-4 2 2 0 010 4zm6 0a2 2 0 110-4 2 2 0 010 4z',
  airport: 'M21 12l-18 6v-4l14-2-14-2V6l18 6z',
  landmark: 'M3 21h18M9 8h6M12 8V3m-6 18V8l6-5 6 5v13'
};
---

<section class="py-16 bg-gradient-to-br from-sand-50 to-white">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Section Header -->
    <div class="text-center mb-10">
      <h2 class="font-display font-semibold text-3xl text-night-900 mb-3">
        Location & Nearby Attractions
      </h2>
      <p class="text-night-600 max-w-2xl mx-auto">
        Explore the area around {propertyName} and discover nearby beaches, restaurants, and points of interest.
      </p>
    </div>

    <!-- Map Container -->
    <div class="bg-white rounded-3xl shadow-2xl shadow-night-900/10 overflow-hidden border border-sand-200">
      <div id="property-map" class="w-full h-[400px] md:h-[500px] lg:h-[600px]"></div>
    </div>

    <!-- Nearby Attractions Cards -->
    {nearbyAttractions && nearbyAttractions.length > 0 && (
      <div class="mt-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {nearbyAttractions.map((attraction) => (
          <div class="bg-white rounded-2xl p-6 border border-sand-200 hover:shadow-xl hover:shadow-coral-500/10 transition-all duration-300">
            <div class="flex items-start gap-4">
              <div class="w-12 h-12 bg-gradient-to-br from-lagoon-400 to-lagoon-600 rounded-xl flex items-center justify-center flex-shrink-0">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d={categoryIcons[attraction.type]} />
                </svg>
              </div>
              <div class="flex-1">
                <h3 class="font-display font-semibold text-lg text-night-900 mb-1">
                  {attraction.name}
                </h3>
                {attraction.description && (
                  <p class="text-sm text-night-600 mb-2">{attraction.description}</p>
                )}
                <div class="flex items-center gap-2 text-coral-600">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                  </svg>
                  <span class="text-sm font-medium">{attraction.distance}</span>
                </div>
              </div>
            </div>
          </div>
        ))}
      </div>
    )}
  </div>
</section>

<script define:vars={{ coordinates, propertyName, nearbyAttractions, apiKey }}>
  // Helper function to get SVG path for category icons
  function getCategoryIconPath(type) {
    const paths = {
      beach: '2 10q4-4 8 0t8 0M2 16q4-4 8 0t8 0',
      restaurant: '8 2v14m8-14v6a2 2 0 01-2 2H8',
      attraction: '12 2l3.1 6.3 6.9.9-5 4.9 1.2 6.9-6.2-3.3-6.2 3.3 1.2-6.9-5-4.9 6.9-.9z',
      shopping: '4 4h2l3.5 10h7l3-7H7.5M10 20a2 2 0 110-4 2 2 0 010 4zm6 0a2 2 0 110-4 2 2 0 010 4z',
      airport: '21 12l-18 6v-4l14-2-14-2V6l18 6z',
      landmark: '3 21h18M9 8h6M12 8V3m-6 18V8l6-5 6 5v13'
    };
    return paths[type] || paths.attraction;
  }

  // Load Google Maps API dynamically
  function loadGoogleMapsAPI() {
    return new Promise((resolve, reject) => {
      // Check if already loaded
      if (window.google && window.google.maps) {
        resolve(window.google);
        return;
      }

      // Create script element
      const script = document.createElement('script');
      script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places`;
      script.async = true;
      script.defer = true;

      script.onload = () => resolve(window.google);
      script.onerror = () => reject(new Error('Failed to load Google Maps API'));

      document.head.appendChild(script);
    });
  }

  // Initialize map
  async function initMap() {
    if (!apiKey || apiKey === 'your_google_maps_api_key_here') {
      console.error('Google Maps API key not configured. Please set PUBLIC_GOOGLE_MAPS_API_KEY in .env file');
      const mapElement = document.getElementById('property-map');
      if (mapElement) {
        mapElement.innerHTML = `
          <div class="flex items-center justify-center h-full bg-sand-50">
            <div class="text-center p-8">
              <div class="w-16 h-16 bg-coral-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-coral-500" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                </svg>
              </div>
              <h3 class="font-semibold text-xl text-night-900 mb-2">Map Configuration Required</h3>
              <p class="text-night-600">Please configure your Google Maps API key to view the map.</p>
            </div>
          </div>
        `;
      }
      return;
    }

    try {
      // Load Google Maps API
      const google = await loadGoogleMapsAPI();
      const mapElement = document.getElementById('property-map');

      if (!mapElement) return;

      // Custom map styles matching brand colors
      const mapStyles = [
        {
          featureType: 'water',
          elementType: 'geometry',
          stylers: [{ color: '#14b8a3' }] // lagoon-500
        },
        {
          featureType: 'landscape',
          elementType: 'geometry',
          stylers: [{ color: '#fefdfb' }] // sand-50
        },
        {
          featureType: 'poi.park',
          elementType: 'geometry',
          stylers: [{ color: '#ccfbf4' }] // lagoon-100
        },
        {
          featureType: 'road',
          elementType: 'geometry.fill',
          stylers: [{ color: '#ffffff' }]
        },
        {
          featureType: 'road',
          elementType: 'geometry.stroke',
          stylers: [{ color: '#e3e7ea' }] // night-100
        },
        {
          featureType: 'poi',
          elementType: 'labels.text.fill',
          stylers: [{ color: '#1a1f24' }] // night-900
        },
        {
          featureType: 'poi',
          elementType: 'labels.text.stroke',
          stylers: [{ color: '#ffffff' }, { weight: 2 }]
        }
      ];

      // Initialize map
      const map = new google.maps.Map(mapElement, {
        center: coordinates,
        zoom: 13,
        styles: mapStyles,
        mapTypeControl: true,
        streetViewControl: true,
        fullscreenControl: true,
        zoomControl: true,
        mapTypeControlOptions: {
          style: google.maps.MapTypeControlStyle.DROPDOWN_MENU,
        },
      });

      // Create property marker with custom icon
      const propertyMarker = new google.maps.Marker({
        position: coordinates,
        map: map,
        title: propertyName,
        icon: {
          url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
            <svg width="48" height="48" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
              <defs>
                <linearGradient id="coral-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" style="stop-color:#e76a40" />
                  <stop offset="100%" style="stop-color:#d4502a" />
                </linearGradient>
              </defs>
              <circle cx="24" cy="24" r="20" fill="url(#coral-gradient)" stroke="white" stroke-width="3"/>
              <path d="M24 12l8 8h-4v8h-8v-8h-4z" fill="white"/>
            </svg>
          `),
          scaledSize: new google.maps.Size(48, 48),
          anchor: new google.maps.Point(24, 24),
        },
        animation: google.maps.Animation.DROP,
      });

      // Property info window
      const propertyInfoWindow = new google.maps.InfoWindow({
        content: `
          <div style="padding: 12px; min-width: 200px; font-family: 'Outfit', sans-serif;">
            <h3 style="font-family: 'Fraunces', serif; font-weight: 600; font-size: 18px; color: #1a1f24; margin-bottom: 8px;">
              ${propertyName}
            </h3>
            <p style="font-size: 14px; color: #6b7280; margin: 0;">
              Your holiday home in paradise
            </p>
          </div>
        `
      });

      propertyMarker.addListener('click', () => {
        propertyInfoWindow.open(map, propertyMarker);
      });

      // Add nearby attraction markers
      if (nearbyAttractions && nearbyAttractions.length > 0) {
        nearbyAttractions.forEach((attraction) => {
          const attractionMarker = new google.maps.Marker({
            position: attraction.coordinates,
            map: map,
            title: attraction.name,
            icon: {
              url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                <svg width="36" height="36" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg">
                  <circle cx="18" cy="18" r="16" fill="#14b8a3" stroke="white" stroke-width="2"/>
                  <path d="M${getCategoryIconPath(attraction.type)}" fill="white" stroke="none" transform="translate(10, 10) scale(0.65)"/>
                </svg>
              `),
              scaledSize: new google.maps.Size(36, 36),
              anchor: new google.maps.Point(18, 18),
            },
          });

          const attractionInfoWindow = new google.maps.InfoWindow({
            content: `
              <div style="padding: 12px; min-width: 200px; font-family: 'Outfit', sans-serif;">
                <h3 style="font-family: 'Fraunces', serif; font-weight: 600; font-size: 16px; color: #1a1f24; margin-bottom: 8px;">
                  ${attraction.name}
                </h3>
                ${attraction.description ? `<p style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">${attraction.description}</p>` : ''}
                <div style="display: flex; align-items: center; gap: 8px; color: #e76a40;">
                  <svg style="width: 16px; height: 16px;" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                  </svg>
                  <span style="font-size: 14px; font-weight: 500;">${attraction.distance}</span>
                </div>
              </div>
            `
          });

          attractionMarker.addListener('click', () => {
            attractionInfoWindow.open(map, attractionMarker);
          });
        });
      }

      // Auto-open property info window after a short delay
      setTimeout(() => {
        propertyInfoWindow.open(map, propertyMarker);
      }, 500);

    } catch (error) {
      console.error('Error loading Google Maps:', error);
      const mapElement = document.getElementById('property-map');
      if (mapElement) {
        mapElement.innerHTML = `
          <div class="flex items-center justify-center h-full bg-sand-50">
            <div class="text-center p-8">
              <div class="w-16 h-16 bg-coral-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-coral-500" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                </svg>
              </div>
              <h3 class="font-semibold text-xl text-night-900 mb-2">Unable to load map</h3>
              <p class="text-night-600">Please check your internet connection and try again.</p>
            </div>
          </div>
        `;
      }
    }
  }

  // Use Intersection Observer for lazy loading
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        initMap();
        observer.disconnect();
      }
    });
  }, { threshold: 0.1 });

  const mapElement = document.getElementById('property-map');
  if (mapElement) {
    observer.observe(mapElement);
  }
</script>
